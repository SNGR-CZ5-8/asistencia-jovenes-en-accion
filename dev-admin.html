<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SNGR · Admin Asistencias – Jóvenes en Acción</title>
  <meta name="description" content="Panel de administración del programa Jóvenes en Acción (SNGR).">
  <meta name="theme-color" content="#2F338F">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Estilos CSS */
    :root{
      --brand:#2F338F; --brand-600:#242870;
      --bg:#f4f6fb; --card:#ffffff;
      --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
      --radius:14px; --shadow:0 10px 25px rgba(17,24,39,.08);
      --ok:#16a34a; --err:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text); display:flex; flex-direction:column;
    }
    .page-header{
      background:linear-gradient(180deg,var(--brand) 0%, var(--brand-600) 100%);
      color:#fff; padding:22px 16px;
    }
    .wrap{max-width:980px; margin:0 auto; display:flex; align-items:center; gap:12px}
    .logo{height:44px}
    .h-txt h1{margin:0; font-size:1.2rem; font-weight:700}
    .h-txt p{margin:4px 0 0; opacity:.9}
    main{flex:1; display:flex; justify-content:center; padding:26px 14px}
    .card{
      width:100%; max-width:980px; background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); border:1px solid var(--line); overflow:hidden;
    }
    .card-head{padding:20px 20px 8px; border-bottom:1px solid var(--line)}
    .card-head h2{margin:0; color:var(--brand); font-size:1.1rem}
    .card-head p{margin:6px 0 0; color:var(--muted)}
    .card-body{padding:20px}
    .grid{display:grid; gap:14px; grid-template-columns:1fr}
    @media(min-width:820px){ .grid{grid-template-columns:1fr 1fr} }
    .full{grid-column:1 / -1}
    label{font-weight:600; font-size:.92rem; margin-bottom:6px; display:block}
    .input,.select,.textarea{
      width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; font-size:1rem; outline:0;
      transition:border .15s ease, box-shadow .15s ease;
    }
    .input:focus,.select:focus,.textarea:focus{border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .input[readonly]{background:#f8fafc; color:#4b5563}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    
    .id-row{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end}
    
    .btn{border:0; border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer; font-size:1rem; display:inline-flex; align-items:center; gap:10px; justify-content:center;}
    .btn-primary{background:var(--brand); color:#fff}
    .btn-primary:hover{background:var(--brand-600)}
    .btn[disabled]{opacity:.8; cursor:not-allowed}
    .ic{width:18px; height:18px; display:inline-block; vertical-align:middle}
    
    /* Clase 'status' para mensajes de éxito/error */
    .status{
      display:none; /* Corregido: Oculto por defecto */
      gap:12px; align-items:flex-start;
      padding:14px 16px; border:1px solid;
      border-radius:12px; font-size:.95rem; margin:8px 0 16px;
    }
    /* Se mostrará cuando tenga la clase 'success' o 'error' */
    .status.success{
      display:flex; border-color:var(--ok); background:#ecfdf5; color:#065f46;
    }
    .status.error{
      display:flex; border-color:var(--err); background:#fef2f2; color:#7f1d1d;
    }
    
    .participante-info{
      background: #f8fafc; border: 1px solid var(--line); border-radius: 12px;
      padding: 12px 16px; margin-top: 10px; font-size: 0.95rem;
    }
    .participante-info strong { color: var(--brand); }

    .spinner{
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,.55);
      border-right-color:transparent;
      animation:spin .6s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    footer{
      text-align:center; padding:20px; color:var(--muted); font-size: 0.9rem;
    }
  </style>
</head>
<body>
  
  <header class="page-header">
    <div class="wrap">
      <img src="sngr.png" alt="SNGR" class="logo">
      <div class="h-txt">
        <h1>SNGR – Admin Asistencias</h1>
        <p>Programa “Jóvenes en Acción” · Módulo de Control</p>
      </div>
    </div>
  </header>

  <main>
    <section class="card" role="region" aria-labelledby="t">
      <div class="card-head">
        <h2 id="t">Habilitar Asistencia</h2>
        <p>Paso 1: Verifica la cédula del participante. Paso 2: Configura la sesión.</p>
      </div>

      <div class="card-body">
        
        <div id="status-message" class="status full" role="alert"></div>

        <form id="frm-admin" novalidate>
          
          <div class="grid">
            <div class="full">
              <label for="cedula">Cédula del Participante *</label>
              <div class="id-row">
                <input id="cedula" class="input" type="text" inputmode="numeric" placeholder="Ej.: 1753631652" required>
                <button type="button" id="btn-verificar" class="btn btn-primary" aria-label="Verificar cédula">
                  <svg class="ic" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="11" cy="11" r="7" stroke-width="2"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2"></line>
                  </svg>
                  Verificar
                </button>
              </div>
            </div>
          </div>
          
          <div id="datos-participante" class="participante-info full" hidden></div>


          <div id="campos-habilitacion" class="grid" style="display:none; margin-top: 16px; border-top: 1px solid var(--line); padding-top: 20px;">
            
            <h3 class="full" style="margin:0 0 4px 0; color: var(--brand);">Configurar Sesión</h3>

            <div>
              <label for="modalidad">Modalidad *</label>
              <select id="modalidad" class="select" required>
                <option value="">Seleccione una...</option>
                <option value="Virtual">Virtual</option>
                <option value="Presencial">Presencial</option>
              </select>
            </div>

            <div>
              <label for="fecha_sesion">Fecha de la Sesión *</label>
              <input id="fecha_sesion" class="input" type="date" required>
            </div>

            <div class="row full">
              <div>
                <label for="hora_inicio">Hora de Inicio *</label>
                <input id="hora_inicio" class="input" type="time" required>
              </div>
              <div>
                <label for="hora_fin">Hora de Fin *</label>
                <input id="hora_fin" class="input" type="time" required>
              </div>
            </div>
            
            <div class="full" style="margin-top: 20px;">
              <button type="submit" id="btn-habilitar" class="btn btn-primary">
                <svg class="ic" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M12 20v-8m0 0V4m0 8h8m-8 0H4" stroke-width="2"></path>
                </svg>
                Habilitar Participante
              </button>
            </div>
          </div>
          
        </form>
      </div>
    </section>
  </main>

  <footer>© 2025 SNGR – Coordinación Zonal 5-8 · Uso interno</footer>

  <script>
    // URL de tu API de Google Apps Script
    const API_URL = "https://script.google.com/macros/s/AKfycbwuD498GGz7FDgNFctqdlEsAGez3QHiF3ievUou5oQWqSUIuT2oL5WEgpp-rbe72k5O/exec";

    // --- ELEMENTOS DEL DOM ---
    const form = document.getElementById('frm-admin');
    const statusMessage = document.getElementById('status-message');
    
    const cedulaInput = document.getElementById('cedula');
    const btnVerificar = document.getElementById('btn-verificar');
    const datosParticipante = document.getElementById('datos-participante');
    
    const camposHabilitacion = document.getElementById('campos-habilitacion');
    const btnHabilitar = document.getElementById('btn-habilitar');

    // --- FUNCIÓN PARA MOSTRAR ESTADO (CORREGIDA) ---
    function setStatus(message, type = 'error') {
      statusMessage.textContent = message;
      // Si hay mensaje, aplica la clase (success/error) para mostrarlo
      // Si el mensaje está vacío (''), quita las clases para ocultarlo
      statusMessage.className = message ? `status full ${type}` : 'status full';
    }
    
    // --- PASO 1: LÓGICA DE VERIFICACIÓN ---
    btnVerificar.addEventListener('click', async () => {
      const cedula = cedulaInput.value.trim();
      if (cedula.length !== 10) {
        setStatus('La cédula debe tener 10 dígitos.', 'error');
        return;
      }
      
      const originalBtnHTML = btnVerificar.innerHTML;
      btnVerificar.disabled = true;
      cedulaInput.disabled = true;
      btnVerificar.innerHTML = '<span class="spinner"></span> Verificando...';
      
      // Limpia mensajes (CORRECCIÓN)
      setStatus(''); 

      try {
        const params = new URLSearchParams();
        params.append('action', 'verificarCedula'); 
        params.append('cedula', cedula);

        const res = await fetch(API_URL, { method: 'POST', body: params });
        const data = await res.json();

        if (data.found) {
          // ¡Encontrado! Mostramos datos y formulario
          datosParticipante.innerHTML = `<strong>Participante:</strong> ${data.apellidos || ''} ${data.nombres || ''}`;
          datosParticipante.hidden = false;
          camposHabilitacion.style.display = 'grid'; 
          setStatus(''); // Limpiar cualquier error
          
          // Pre-llenar campos si ya existen
          document.getElementById('modalidad').value = data.modalidad || '';
          document.getElementById('fecha_sesion').value = data.fecha || '';
          document.getElementById('hora_inicio').value = data.horaInicio || '';
          document.getElementById('hora_fin').value = data.horaFin || '';

        } else {
          // No encontrado
          setStatus('Cédula no encontrada en la base de datos.', 'error');
          datosParticipante.hidden = true;
          camposHabilitacion.style.display = 'none'; 
        }

      } catch (err) {
        console.error(err);
        setStatus('Error de conexión. Intente nuevamente.', 'error');
      } finally {
        // Restaurar botón y campo
        btnVerificar.disabled = false;
        cedulaInput.disabled = false;
        btnVerificar.innerHTML = originalBtnHTML;
      }
    });


    // --- PASO 2: LÓGICA DE HABILITACIÓN (SUBMIT) ---
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const cedula = cedulaInput.value.trim(); 
      const modalidad = document.getElementById('modalidad').value;
      const fecha = document.getElementById('fecha_sesion').value;
      const horaInicio = document.getElementById('hora_inicio').value;
      const horaFin = document.getElementById('hora_fin').value;

      if (!cedula || !modalidad || !fecha || !horaInicio || !horaFin) {
        setStatus('Todos los campos de configuración son obligatorios.', 'error');
        return;
      }
      
      const originalBtnHTML = btnHabilitar.innerHTML;
      btnHabilitar.disabled = true;
      btnHabilitar.innerHTML = '<span class="spinner"></span> Habilitando...';
      setStatus(''); // Limpiar mensajes

      try {
        const params = new URLSearchParams();
        params.append('action', 'habilitarAsistencia');
        params.append('cedula', cedula);
        params.append('modalidad', modalidad);
        params.append('fecha', fecha);
        params.append('horaInicio', horaInicio);
        params.append('horaFin', horaFin);

        const res = await fetch(API_URL, { method: 'POST', body: params });
        const data = await res.json();

        if (data.success) {
          setStatus('¡Participante habilitado con éxito!', 'success');
          // Opcional: puedes resetear el formulario si lo deseas
          // form.reset();
          // camposHabilitacion.style.display = 'none';
          // datosParticipante.hidden = true;
          
        } else {
          setStatus(data.message || 'Error desconocido al habilitar.', 'error');
        }

      } catch (err) {
        console.error(err);
        setStatus('Error de conexión. No se pudo habilitar.', 'error');
      } finally {
        // Restaurar botón
        btnHabilitar.disabled = false;
        btnHabilitar.innerHTML = originalBtnHTML;
      }
    });
  </script>
</body>
</html>
