<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SNGR · Registro de Capacitación – Jóvenes en Acción</title>

  <meta name="description" content="Registro de actividades de capacitación del programa Jóvenes en Acción (SNGR).">
  <meta name="theme-color" content="#2F338F">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#2F338F; --brand-600:#242870;
      --bg:#f4f6fb; --card:#ffffff;
      --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
      --radius:14px; --shadow:0 10px 25px rgba(17,24,39,.08);
      --ok:#16a34a; --err:#dc2626; --info:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text); display:flex; flex-direction:column;
    }
    .page-header{
      background:linear-gradient(180deg,var(--brand) 0%, var(--brand-600) 100%);
      color:#fff; padding:22px 16px;
    }
    .wrap{max-width:980px; margin:0 auto; display:flex; align-items:center; gap:12px}
    .logo{height:44px}
    .h-txt h1{margin:0; font-size:1.2rem; font-weight:700}
    .h-txt p{margin:4px 0 0; opacity:.9}
    main{flex:1; display:flex; justify-content:center; padding:26px 14px}
    .card{
      width:100%; max-width:980px; background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); border:1px solid var(--line); overflow:hidden;
    }
    .card-head{padding:20px 20px 8px; border-bottom:1px solid var(--line)}
    .card-head h2{margin:0; color:var(--brand); font-size:1.1rem}
    .card-head p{margin:6px 0 0; color:var(--muted)}
    .card-body{padding:20px}
    .grid{display:grid; gap:14px; grid-template-columns:1fr}
    @media(min-width:820px){ .grid{grid-template-columns:1fr 1fr} }
    .full{grid-column:1 / -1}
    label{font-weight:600; font-size:.92rem; margin-bottom:6px; display:block}
    .input,.select,.textarea{
      width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; font-size:1rem; outline:0;
      transition:border .15s ease, box-shadow .15s ease;
    }
    .input:focus,.select:focus,.textarea:focus{border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .input[readonly]{background:#f8fafc; color:#4b5563}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .helper{color:var(--muted); font-size:.9rem; margin-top:4px}
    .id-row{display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:end}
    .btn{border:0; border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer; font-size:1rem; display:inline-flex; align-items:center; gap:10px; justify-content:center;}
    .btn-primary{background:var(--brand); color:#fff}
    .btn-primary:hover{background:var(--brand-600)}
    .btn[disabled]{opacity:.8; cursor:not-allowed}
    .badge{
      display:inline-flex; align-items:center; gap:8px; border:1px solid var(--line);
      padding:8px 10px; border-radius:999px; font-size:.9rem; color:#111827; background:#f8fafc;
    }
    .badge.ok{border-color:#86efac; background:#ecfdf5; color:#065f46}
    .badge.err{border-color:#fecaca; background:#fef2f2; color:#7f1d1d}
    .notice{
      display:flex; gap:12px; align-items:flex-start;
      padding:14px 16px; border:1px solid;
      border-radius:12px; font-size:.95rem; margin:8px 0 16px;
    }
    .notice.err{border-color:var(--err); background:#fef2f2; color:#7f1d1d;}
    .notice.ok{border-color:var(--ok); background:#ecfdf5; color:#065f46;}
    .notice.info{border-color:#93c5fd; background:#eff6ff; color:var(--info);}
    .spinner{width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,.55); border-right-color:transparent; animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<header class="page-header">
  <div class="wrap">
    <img src="sngr.png" class="logo">
    <div class="h-txt">
      <h1>SNGR – Registro de Capacitación</h1>
      <p>Programa “Jóvenes en Acción” · Uso interno</p>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="card-head">
      <h2>Formulario de Capacitación</h2>
      <p>Verifica tu cédula para registrar tu asistencia. Solo podrás registrarte en el horario habilitado.</p>
    </div>

    <div class="card-body">
      <form id="frm" class="grid" novalidate>

        <div class="full">
          <label for="cedula">Cédula *</label>
          <div class="id-row">
            <input id="cedula" class="input" type="text" inputmode="numeric" placeholder="Ej.: 1753631652">
            <button type="button" id="btn-verificar" class="btn btn-primary">
              <svg class="ic" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
              Verificar
            </button>
            <span id="badge-estado" class="badge" hidden></span>
          </div>
        </div>

        <div id="ident-existente" class="full" hidden>
          <div class="row">
            <div>
              <label>Apellidos</label>
              <input id="apellidos_ro" class="input" readonly>
            </div>
            <div>
              <label>Nombres</label>
              <input id="nombres_ro" class="input" readonly>
            </div>
          </div>
        </div>

        <div id="bloque-no-encontrado" class="full" hidden>
          <div class="notice err"><strong>No estás registrado/a.</strong></div>
        </div>

        <div id="bloque-mensaje" class="full" hidden></div>

        <div id="bloque-registro" class="full" hidden>
          <p><strong>Horario habilitado:</strong></p>
          <p>Modalidad: <span id="info-modalidad"></span></p>
          <p>Horario: <span id="info-horario"></span></p>

          <button id="btn-registrar" class="btn btn-primary" type="submit">
            Registrar mi Asistencia
          </button>
        </div>

      </form>
    </div>
  </section>
</main>

<footer>© 2025 SNGR – Coordinación Zonal 5-8 · Uso interno</footer>

<script>
const API_URL = "https://yellow-cherry-162f.dylanvillasagua.workers.dev/";

const cedulaInput = document.getElementById("cedula");
const btnVerificar = document.getElementById("btn-verificar");
const badgeEstado = document.getElementById("badge-estado");
const identExistente = document.getElementById("ident-existente");
const bloqueNoEncontrado = document.getElementById("bloque-no-encontrado");
const bloqueMensaje = document.getElementById("bloque-mensaje");
const bloqueRegistro = document.getElementById("bloque-registro");
const btnRegistrar = document.getElementById("btn-registrar");

function limpiarBloques() {
  identExistente.hidden = true;
  bloqueNoEncontrado.hidden = true;
  bloqueMensaje.hidden = true;
  bloqueRegistro.hidden = true;
  badgeEstado.hidden = true;
}

function mensaje(texto, tipo="info") {
  bloqueMensaje.hidden = false;
  bloqueMensaje.className = "full notice " + tipo;
  bloqueMensaje.textContent = texto;
}

function validarHorario(fecha, inicio, fin) {
  if (!fecha || !inicio || !fin) return {ok:true};

  const [y,m,d] = fecha.split("-").map(Number);
  const [h1,mi1] = inicio.split(":").map(Number);
  const [h2,mi2] = fin.split(":").map(Number);

  const ahora = new Date();
  const t1 = new Date(y, m-1, d, h1, mi1);
  const t2 = new Date(y, m-1, d, h2, mi2);

  if (ahora < t1) return {ok:false, msg:"Aún no está habilitado el registro."};
  if (ahora > t2) return {ok:false, msg:"El registro ya se cerró."};

  return {ok:true};
}

btnVerificar.addEventListener("click", async () => {
  limpiarBloques();
  const ced = cedulaInput.value.trim();
  if (ced.length !== 10) return mensaje("La cédula debe tener 10 dígitos","err");

  btnVerificar.disabled = true;
  cedulaInput.disabled = true;
  btnVerificar.innerHTML = '<span class="spinner"></span> Verificando...';

  try {
    const params = new URLSearchParams();
    params.append("action","verificarCedula");
    params.append("cedula",ced);

    const res = await fetch(API_URL,{
      method:"POST",
      headers:{ "Accept":"application/json" },
      body:params
    });

    if (!res.ok) throw new Error("Error de red");

    const data = await res.json();

    if (!data.found) {
      bloqueNoEncontrado.hidden = false;
      return mensaje("Cédula no encontrada","err");
    }

    identExistente.hidden = false;
    document.getElementById("apellidos_ro").value = data.apellidos;
    document.getElementById("nombres_ro").value = data.nombres;

    const estado = (data.estado_asistencia || "").toUpperCase();

    if (estado === "ASISTIÓ" || estado === "REGISTRADO") {
      badgeEstado.hidden = false;
      badgeEstado.className = "badge ok";
      badgeEstado.textContent = "Asistencia Registrada";
      return mensaje("Ya registraste tu asistencia.","ok");
    }

    if (estado !== "HABILITADO") {
      badgeEstado.hidden = false;
      badgeEstado.className = "badge err";
      badgeEstado.textContent = "No habilitado";
      return mensaje("No estás habilitado para esta sesión.","info");
    }

    const h = validarHorario(data.fecha,data.horaInicio,data.horaFin);

    badgeEstado.hidden = false;
    badgeEstado.className = "badge ok";
    badgeEstado.textContent = "Habilitado";

    if (!h.ok) return mensaje(h.msg,"info");

    bloqueRegistro.hidden = false;
    document.getElementById("info-modalidad").textContent = data.modalidad;
    document.getElementById("info-horario").textContent = `${data.horaInicio} – ${data.horaFin} / ${data.fecha}`;

  } catch(e) {
    mensaje("Error de conexión. Intenta nuevamente.","err");
  }

  btnVerificar.disabled = false;
  cedulaInput.disabled = false;
  btnVerificar.innerHTML = "Verificar";
});

document.getElementById("frm").addEventListener("submit", async e=>{
  e.preventDefault();

  btnRegistrar.disabled = true;
  btnRegistrar.innerHTML = '<span class="spinner"></span> Registrando...';

  try {
    const params = new URLSearchParams();
    params.append("action","registrarAsistencia");
    params.append("cedula",cedulaInput.value.trim());

    const res = await fetch(API_URL,{
      method:"POST",
      headers:{ "Accept":"application/json" },
      body:params
    });

    const data = await res.json();

    if (data.success) {
      limpiarBloques();
      identExistente.hidden = false;
      badgeEstado.hidden = false;
      badgeEstado.className = "badge ok";
      badgeEstado.textContent = "Asistencia Registrada";
      return mensaje("¡Asistencia registrada con éxito!","ok");
    }

    mensaje(data.message || "No se pudo registrar.","err");
  } catch(e) {
    mensaje("Error de conexión.","err");
  }

  btnRegistrar.disabled = false;
  btnRegistrar.innerHTML = "Registrar mi Asistencia";
});
</script>

</body>
</html>
